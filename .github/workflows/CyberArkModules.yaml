name: Create CyberArk Safe

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  create-safe:
    runs-on: ubuntu-latest
    steps:
      - name: Install Dependencies
        run: sudo apt-get install -y jq curl

      - name: Authenticate to CyberArk
        id: login
        run: |
          #CYBR_URL = ""
          RESPONSE=$(curl -sk -X POST "https://aay4294.id.cyberark.cloud/oauth2/platformtoken" \
          -H "Content-Type: application/x-www-form-urlencoded" \
          -d "grant_type=client_credentials&client_id=${{ secrets.CYBR_USERNAME }}&client_secret=${{ secrets.CYBR_PASSWORD }}&scope=all")
          
          AUTH_TOKEN=$(echo "$RESPONSE" | jq -r '.access_token')
          echo "::add-mask::$AUTH_TOKEN"
          echo "auth_token=$AUTH_TOKEN" >> $GITHUB_OUTPUT
          #echo "$AUTH_TOKEN" > AUTH_TOKEN.txt
          #echo "Session token file written with $(wc -c < AUTH_TOKEN.txt) bytes"


      - name: Create_Safe
        run: |
          SAFE_NAME="GitHubSafe-6"
          echo "${{ steps.login.outputs.auth_token }}" | sha256sum

          CREATE_PAYLOAD=$(cat <<EOF
          {
            "safeName": "$SAFE_NAME",
            "description": "Safe created via GitHub Actions using CyberArk API v2",
            "managingCPM": "",
            "numberOfVersionsRetention": 5,
            "autoPurgeEnabled": true,
            "olacEnabled": false
          }
          EOF)

          #Resp=$(curl -sk -X POST "https://pwclab.privilegecloud.cyberark.cloud/PasswordVault/API/Safes/" \
          #  -H "Authorization: Bearer ${{ steps.login.outputs.auth_token }}" \
          #  -H "Content-Type: application/json" \
          #  -d "$CREATE_PAYLOAD")

          #echo "Safe onboarding response: $Resp"
          #echo "response=$Resp" >> $GITHUB_OUTPUT
          

      - name: Add_membership
        run: |
          SAFE_NAME="GitHubSafe-7"
          echo "${{ steps.login.outputs.auth_token }}" | sha256sum

          CREATE_PAYLOAD=$(cat <<EOF
          {
            "memberName":"saswat.nayak@pwclab.com",
            "searchIn": "PwC Cloud Directory",
            "membershipExpirationDate":"",
            "permissions":
            {
              "useAccounts": true,
              "retrieveAccounts": true,
              "listAccounts": true,
              "addAccounts": true,
              "updateAccountContent": true,
              "updateAccountProperties": true,
              "initiateCPMAccountManagementOperations": true,
              "specifyNextAccountContent": true,
              "renameAccounts": true,
              "deleteAccounts": true,
              "unlockAccounts": true,
              "manageSafe": true,
              "manageSafeMembers": true,
              "backupSafe": false,
              "viewAuditLog": true,
              "viewSafeMembers": true,
              "accessWithoutConfirmation": true,
              "createFolders": true,
              "deleteFolders": true,
              "moveAccountsAndFolders": true,
              "requestsAuthorizationLevel1": false,
              "requestsAuthorizationLevel2": false
            },
            "MemberType": "User"
          }
          EOF)

          #Resp=$(curl -sk -X POST "https://pwclab.privilegecloud.cyberark.cloud/PasswordVault/API/Safes/$SAFE_NAME/Members/" \
          #  -H "Authorization: Bearer ${{ steps.login.outputs.auth_token }}" \
          #  -H "Content-Type: application/json" \
          #  -d "$CREATE_PAYLOAD")

          #echo "Adding safe membership: $Resp"
          #echo "response=$Resp" >> $GITHUB_OUTPUT
          #we can remove below lines from this function
          #if: contains($Resp, 'safeNumber'); then
          #  echo "Error: Safemembership adding failed with error : $Resp"
          #  #exit 1
          #fi
          #run: echo "âœ… Safe is created."   


      - name: Add_secret
        run: |
          SAFE_NAME="GitHubSafe-6"
          echo "${{ steps.login.outputs.auth_token }}" | sha256sum

          CREATE_PAYLOAD=$(cat <<EOF
          {
            "name": "test-account01",
            "address": "abc.def.com",
            "userName": "abc.def.com",
            "platformId": "GitHubTest",
            "safeName": "$SAFE_NAME",
            "secretType": "key",
            "secret": "heyo",
            "platformAccountProperties": {},
            "secretManagement": 
            {
              "automaticManagementEnabled": true
            }
          }
          EOF)

          Resp=$(curl -sk -X POST "https://pwclab.privilegecloud.cyberark.cloud/PasswordVault/API/Accounts/" \
            -H "Authorization: Bearer ${{ steps.login.outputs.auth_token }}" \
            -H "Content-Type: application/json" \
            -d "$CREATE_PAYLOAD")

          echo "Safe onboarding response: $Resp"
          echo "response=$Resp" >> $GITHUB_OUTPUT
          
